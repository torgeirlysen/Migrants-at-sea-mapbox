<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Migrants at Sea â€” Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="icon" type="image/x-icon"
        href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl-globe-minimap@1.2.0/dist/bundle.js"></script>
    <style>
                
        #topnav {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 10;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 10px 0;
            backdrop-filter: blur(6px);
        }

        #topnav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        #topnav a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
        }

        #topnav a:hover {
            text-decoration: underline;
        }

        /* Push Mapbox controls below the fixed top navbar */
        .mapboxgl-ctrl-top-right,
        .mapboxgl-ctrl-top-left {
            top: 70px !important; /* tweak if navbar height changes */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        a,
        a:hover,
        a:visited {
            color: #0071bc;
        }

        #navbar {
            position: relative;
            z-index: 11;
        }

        #map {
            position: fixed;
            inset: 0;
        }
    </style>
</head>

<body>
    
    <div id="navbar"></div>

    <div id="map"></div>

    <script>
        // The navbar hard-codes links under this base path.
        window.SITE_BASE = '/Migrants-at-sea-mapbox';
    </script>
    <script src="./config.js"></script>

    <script>
        (async function initHome() {
            // Load navbar component (best-effort)
            try {
                const res = await fetch(window.SITE_BASE + '/components/navbar.html');
                document.getElementById('navbar').innerHTML = await res.text();
            } catch (e) {
                console.warn('Navbar failed to load:', e);
            }

            const cfg = window.HOME_CONFIG;
            if (!cfg || !cfg.accessToken) {
                throw new Error('Missing HOME_CONFIG in ./config.js');
            }

            mapboxgl.accessToken = cfg.accessToken;

            const map = new mapboxgl.Map({
                container: 'map',
                style: cfg.style,
                center: cfg.initialView.center,
                zoom: cfg.initialView.zoom,
                bearing: cfg.initialView.bearing || 0,
                pitch: cfg.initialView.pitch || 0,
                projection: cfg.projection || 'mercator'
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            if (cfg.inset) {
                map.addControl(
                    new GlobeMinimap({ ...(cfg.insetOptions || {}) }),
                    cfg.insetPosition || 'bottom-right'
                );
            }

            map.on('load', () => {
                // Insert SAR layers just *below* the land fill layer when possible.
                // This visually "clips" SAR areas to water because land is rendered above.
                const styleLayers = (map.getStyle() && map.getStyle().layers) ? map.getStyle().layers : [];
                const landFillLayer = styleLayers.find(l =>
                    l &&
                    l.type === 'fill' &&
                    (
                        (typeof l.id === 'string' && l.id.toLowerCase().includes('land')) ||
                        (typeof l['source-layer'] === 'string' && l['source-layer'].toLowerCase().includes('land'))
                    )
                );
                const sarBeforeId = landFillLayer ? landFillLayer.id : undefined;

                // --- SAR zones ---
                map.addSource('sar-zones', { type: 'geojson', data: cfg.sarZonesUrl });

                map.addLayer({
                    id: 'sar-fill',
                    type: 'fill',
                    source: 'sar-zones',
                    paint: {
                        'fill-color': ['coalesce', ['get', 'fill'], '#ff8c00'],
                        'fill-opacity': ['coalesce', ['get', 'fill-opacity'], 0.14]
                    }
                }, sarBeforeId);

                map.addLayer({
                    id: 'sar-outline',
                    type: 'line',
                    source: 'sar-zones',
                    paint: {
                        'line-color': ['coalesce', ['get', 'stroke'], '#ff8c00'],
                        'line-width': ['coalesce', ['get', 'stroke-width'], 2],
                        'line-opacity': 0.95
                    }
                }, sarBeforeId);

                map.addLayer({
                    id: 'sar-labels',
                    type: 'symbol',
                    source: 'sar-zones',
                    layout: {
                        'text-field': ['format', ['get', 'name'], { 'font-scale': 1.0 }, '\n', ['get', 'authority'], { 'font-scale': 0.8 }],
                        'text-size': 12,
                        'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
                        'text-anchor': 'center'
                    },
                    paint: {
                        'text-color': '#1a1a1a',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 1.2
                    }
                }, sarBeforeId);

                // --- Case markers (click to open story) ---
                const casesFC = {
                    type: 'FeatureCollection',
                    features: (cfg.cases || []).map(c => ({
                        type: 'Feature',
                        properties: { title: c.title, url: c.url },
                        geometry: { type: 'Point', coordinates: c.coordinates }
                    }))
                };

                map.addSource('cases', { type: 'geojson', data: casesFC });

                map.addLayer({
                    id: 'cases-circle',
                    type: 'circle',
                    source: 'cases',
                    paint: {
                        'circle-radius': 7,
                        'circle-color': '#ff5e00',
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 2,
                        'circle-opacity': 0.95
                    }
                });

                map.addLayer({
                    id: 'cases-label',
                    type: 'symbol',
                    source: 'cases',
                    layout: {
                        'text-field': ['get', 'title'],
                        'text-size': 12,
                        'text-offset': [0, 1.2],
                        'text-anchor': 'top'
                    },
                    paint: {
                        'text-color': '#111',
                        'text-halo-color': '#fff',
                        'text-halo-width': 1.2
                    }
                });

                function openCasePopup(e) {
                    const f = e.features && e.features[0];
                    if (!f) return;
                    const html = `<strong>${f.properties.title}</strong><br><a href="${f.properties.url}">Open story</a>`;
                    new mapboxgl.Popup()
                        .setLngLat(f.geometry.coordinates)
                        .setHTML(html)
                        .addTo(map);
                }

                map.on('click', 'cases-circle', openCasePopup);
                map.on('click', 'cases-label', openCasePopup);

                map.on('mouseenter', 'cases-circle', () => (map.getCanvas().style.cursor = 'pointer'));
                map.on('mouseleave', 'cases-circle', () => (map.getCanvas().style.cursor = ''));
                map.on('mouseenter', 'cases-label', () => (map.getCanvas().style.cursor = 'pointer'));
                map.on('mouseleave', 'cases-label', () => (map.getCanvas().style.cursor = ''));
            });
        })();
    </script>

</body>

</html>