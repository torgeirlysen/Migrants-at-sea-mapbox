<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapbox Storytelling</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="icon" type="image/x-icon"
        href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/mapbox-gl-globe-minimap@1.2.0/dist/bundle.js"></script>
  <script src="https://unpkg.com/scrollama"></script>

  <style>
    #topnav {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 10;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px 0;
      backdrop-filter: blur(6px);
    }

    #topnav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      gap: 40px;
    }

    #topnav a {
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
    }

    #topnav a:hover {
      text-decoration: underline;
    }

    #topnav a.current {
      font-weight: 700;
      text-decoration: underline;
      color: #ff8800;
    }

    /* Push Mapbox controls below the fixed top navbar */
    .mapboxgl-ctrl-top-right,
    .mapboxgl-ctrl-top-left {
      top: 70px !important;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    a,
    a:hover,
    a:visited {
      color: #0071bc;
    }

    #map {
      top: 0;
      height: 100vh;
      width: 100vw;
      position: fixed;
    }

    #header {
      margin: auto;
      width: 100%;
      position: relative;
      z-index: 5;
    }

    #header h1,
    #header h2,
    #header p {
      margin: 0;
      padding: 2vh 2vw;
      text-align: center;
    }

    #footer {
      width: 100%;
      min-height: 5vh;
      padding-top: 2vh;
      padding-bottom: 2vh;
      text-align: center;
      line-height: 25px;
      font-size: 13px;
      position: relative;
      z-index: 5;
    }

    #features {
      padding-top: 10vh;
      padding-bottom: 10vh;
    }

    .hidden {
      visibility: hidden;
    }

    .centered {
      width: 50vw;
      margin: 0 auto;
    }

    .lefty {
      width: 33vw;
      margin-left: 5vw;
      margin-top: 20vw;
    }

    .righty {
      width: 33vw;
      margin-left: 62vw;
    }

    .fully {
      width: 100%;
      margin: auto;
    }

    .light {
      color: #444;
      background-color: #fafafa;
    }

    .dark {
      color: #fafafa;
      background-color: #444;
    }

    .step {
      padding-bottom: 50vh;
      opacity: 0.25;
    }

    .step.active {
      opacity: 0.9;
    }

    .step div {
      padding: 25px 50px;
      line-height: 25px;
      font-size: 13px;
    }

    .step img {
      width: 100%;
    }

    @media (max-width: 750px) {
      .centered,
      .lefty,
      .righty,
      .fully,
      .bottom-left {
        width: 90vw;
        margin: 0 auto;
        left: 5vw;
        bottom: 5vh;
      }
    }

    /* Fix issue on mobile browser where scroll breaks */
    .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
    .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
      touch-action: unset;
    }
  </style>
</head>

<body>
  <div id="navbar"></div>

  <div id="map"></div>
  <div id="story"></div>

  <script src="./config.js"></script>

  <script>
    // -------- NAVBAR INJECTION + ACTIVE LINK HIGHLIGHT --------
    function highlightCurrentNav() {
      const currentPath = window.location.pathname.replace(/\/+$/, '');
      document.querySelectorAll('#topnav a').forEach(a => {
        const linkPath = new URL(a.href).pathname.replace(/\/+$/, '');
        if (linkPath === currentPath) a.classList.add('current');
      });
    }

    // Adjust this if your folder depth changes
    fetch('../../components/navbar/index.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbar').innerHTML = html;
        highlightCurrentNav();
      });

    // -------- STORYTELLING TEMPLATE LOGIC --------
    var initLoad = true;
    var layerTypes = {
      'fill': ['fill-opacity'],
      'line': ['line-opacity'],
      'circle': ['circle-opacity', 'circle-stroke-opacity'],
      'symbol': ['icon-opacity', 'text-opacity'],
      'raster': ['raster-opacity'],
      'fill-extrusion': ['fill-extrusion-opacity'],
      'heatmap': ['heatmap-opacity']
    };

    var alignments = {
      'left': 'lefty',
      'center': 'centered',
      'right': 'righty',
      'full': 'fully'
    };

    var map; // will be assigned after mapbox init

    function getLayerPaintType(layer) {
      var layerType = map.getLayer(layer).type;
      return layerTypes[layerType];
    }

    function setLayerOpacity(layer) {
      var paintProps = getLayerPaintType(layer.layer);
      paintProps.forEach(function (prop) {
        var options = {};
        if (layer.duration) {
          var transitionProp = prop + "-transition";
          options = { "duration": layer.duration };
          map.setPaintProperty(layer.layer, transitionProp, options);
        }
        map.setPaintProperty(layer.layer, prop, layer.opacity, options);
      });
    }

    var storyEl = document.getElementById('story');
    var features = document.createElement('div');
    features.setAttribute('id', 'features');

    var header = document.createElement('div');

    if (config.title) {
      var titleText = document.createElement('h1');
      titleText.innerText = config.title;
      header.appendChild(titleText);
    }

    if (config.subtitle) {
      var subtitleText = document.createElement('h2');
      subtitleText.innerText = config.subtitle;
      header.appendChild(subtitleText);
    }

    if (config.byline) {
      var bylineText = document.createElement('p');
      bylineText.innerText = config.byline;
      header.appendChild(bylineText);
    }

    if (header.innerText.length > 0) {
      header.classList.add(config.theme);
      header.setAttribute('id', 'header');
      storyEl.appendChild(header);
    }

    config.chapters.forEach((record, idx) => {
      var container = document.createElement('div');
      var chapter = document.createElement('div');

      if (record.title) {
        var title = document.createElement('h3');
        title.innerText = record.title;
        chapter.appendChild(title);
      }

      if (record.image) {
        var image = new Image();
        image.src = record.image;
        chapter.appendChild(image);
      }

      if (record.description) {
        var desc = document.createElement('p');
        desc.innerHTML = record.description;
        chapter.appendChild(desc);
      }

      container.setAttribute('id', record.id);
      container.classList.add('step');
      if (idx === 1) container.classList.add('active');

      chapter.classList.add(config.theme);
      container.appendChild(chapter);

      container.classList.add(alignments[record.alignment] || 'centered');
      if (record.hidden) container.classList.add('hidden');

      features.appendChild(container);
    });

    storyEl.appendChild(features);

    var footer = document.createElement('div');

    if (config.footer) {
      var footerText = document.createElement('p');
      footerText.innerHTML = config.footer;
      footer.appendChild(footerText);
    }

    if (footer.innerText.length > 0) {
      footer.classList.add(config.theme);
      footer.setAttribute('id', 'footer');
      storyEl.appendChild(footer);
    }

    mapboxgl.accessToken = config.accessToken;

    map = new mapboxgl.Map({
      container: 'map',
      style: config.style,
      center: config.chapters[1].location.center,
      zoom: config.chapters[1].location.zoom,
      bearing: config.chapters[1].location.bearing,
      pitch: config.chapters[1].location.pitch,
      interactive: true,
      projection: config.projection
    });

    // Map controls
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.scrollZoom.disable();

    // Inset map
    if (config.inset) {
      if (typeof GlobeMinimap !== 'undefined') {
        map.addControl(new GlobeMinimap({ ...config.insetOptions }), config.insetPosition);
      } else {
        console.warn('GlobeMinimap not available. Inset disabled.');
      }
    }

    // Optional marker
    var marker;
    if (config.showMarkers) {
      marker = new mapboxgl.Marker({ color: config.markerColor });
      marker.setLngLat(config.chapters[1].location.center).addTo(map);
    }

    // Scrollama
    var scroller = scrollama();

    map.on("load", function () {

      // Optional: draw chapter path (disable per page by setting showPath: false in config.js)
      if (config.showPath !== false) {
        const pathGeoJSON = {
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: config.chapters.slice(1).map(c => c.location.center)
          },
          properties: {}
        };

        map.addSource('chapter-path', {
          type: 'geojson',
          data: pathGeoJSON
        });

        map.addLayer({
          id: 'chapter-path-layer',
          type: 'line',
          source: 'chapter-path',
          layout: {
            'line-join': 'round',
            'line-cap': 'round'
          },
          paint: {
            'line-width': 3,
            'line-color': '#ff8c00',
            'line-opacity': 0.8
          }
        });
      }

      // 3D terrain
      if (config.use3dTerrain) {
        map.addSource('mapbox-dem', {
          type: 'raster-dem',
          url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
          tileSize: 512,
          maxzoom: 14
        });

        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });

        map.addLayer({
          id: 'sky',
          type: 'sky',
          paint: {
            'sky-type': 'atmosphere',
            'sky-atmosphere-sun': [0.0, 0.0],
            'sky-atmosphere-sun-intensity': 15
          }
        });
      }

      // Chapter highlight point
      map.addSource('chapter-highlight', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      map.addLayer({
        id: 'chapter-highlight-layer',
        type: 'circle',
        source: 'chapter-highlight',
        paint: {
          'circle-radius': 10,
          'circle-color': '#ff5e00',
          'circle-opacity': 0.95,
          'circle-stroke-color': '#ff5e00',
          'circle-stroke-width': 3
        }
      });

      scroller
        .setup({
          step: '.step',
          offset: 0.5,
          progress: true
        })
        .onStepEnter(response => {
          const chapter = config.chapters.find(chap => chap.id === response.element.id);
          if (!chapter) {
            console.warn('No matching chapter for step id:', response.element.id);
            return;
          }

          response.element.classList.add('active');
          map[chapter.mapAnimation || 'flyTo'](chapter.location);

          // Move highlight point to chapter center
          if (!chapter.hidden) {
            map.getSource('chapter-highlight').setData({
              type: 'FeatureCollection',
              features: [{
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: chapter.location.center
                },
                properties: {}
              }]
            });
          }

          if (config.showMarkers && marker) marker.setLngLat(chapter.location.center);

          if (Array.isArray(chapter.onChapterEnter) && chapter.onChapterEnter.length > 0) {
            chapter.onChapterEnter.forEach(setLayerOpacity);
          }

          if (chapter.callback && typeof window[chapter.callback] === 'function') {
            window[chapter.callback]();
          }

          if (chapter.rotateAnimation) {
            map.once('moveend', () => {
              const rotateNumber = map.getBearing();
              map.rotateTo(rotateNumber + 180, {
                duration: 30000,
                easing: function (t) { return t; }
              });
            });
          }

          if (config.auto) {
            const currentIdx = config.chapters.findIndex(chap => chap.id === chapter.id);
            const nextIdx = (currentIdx + 1) % config.chapters.length;
            map.once('moveend', () => {
              const next = document.querySelectorAll('[data-scrollama-index="' + nextIdx.toString() + '"]')[0];
              if (next) next.scrollIntoView();
            });
          }
        })
        .noteStepExit(response => {
          const chapter = config.chapters.find(chap => chap.id === response.element.id);
          response.element.classList.remove('active');

          if (chapter && Array.isArray(chapter.onChapterExit) && chapter.onChapterExit.length > 0) {
            chapter.onChapterExit.forEach(setLayerOpacity);
          }
        });

      // Ensure scrollama calculates positions correctly after load
      setTimeout(() => scroller.resize(), 0);
      window.addEventListener('resize', () => scroller.resize());

      if (config.auto) {
        const first = document.querySelectorAll('[data-scrollama-index="0"]')[0];
        if (first) first.scrollIntoView();
      }
    });
  </script>
</body>
</html>
